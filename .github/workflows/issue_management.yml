name: Issue Auto-Management

on:
  schedule:
    # Run every 12 hours
    - cron: '0 */12 * * *'
  issues:
    types: [opened, labeled]

jobs:
  triage-new-issues:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Add triage comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ‘‹ Merci pour votre issue ! / Thank you for your issue!

            **ðŸ‡«ðŸ‡· FranÃ§ais:**
            Votre issue a Ã©tÃ© crÃ©Ã©e et sera examinÃ©e prochainement. Pour accÃ©lÃ©rer le traitement :
            - âœ… VÃ©rifiez que vous avez fourni toutes les informations demandÃ©es
            - ðŸ“‹ Consultez la [documentation](https://github.com/daangel27/haptique_rs90/blob/main/README.md)
            - ðŸ”„ Si vous migrez depuis v1.2.x, consultez le [guide de migration](https://github.com/daangel27/haptique_rs90/blob/main/MIGRATION_GUIDE_v1.5.0.md)

            **â° Important:** Si nous avons besoin d'informations supplÃ©mentaires et qu'il n'y a pas de rÃ©ponse dans les 7 jours, cette issue sera automatiquement fermÃ©e.

            ---

            **ðŸ‡¬ðŸ‡§ English:**
            Your issue has been created and will be reviewed shortly. To speed up processing:
            - âœ… Verify you provided all requested information
            - ðŸ“‹ Check the [documentation](https://github.com/daangel27/haptique_rs90/blob/main/README.md)
            - ðŸ”„ If migrating from v1.2.x, see [migration guide](https://github.com/daangel27/haptique_rs90/blob/main/MIGRATION_GUIDE_v1.5.0.md)

            **â° Important:** If we need additional information and there's no response within 7 days, this issue will be automatically closed.`
            })

  check-stale-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Check for stale issues
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          
          # Issues awaiting user response
          stale-issue-message: |
            **â° Waiting for Response / En attente de rÃ©ponse**

            ðŸ‡«ðŸ‡· **FranÃ§ais:**
            Cette issue est marquÃ©e comme "en attente de rÃ©ponse" car nous avons besoin d'informations supplÃ©mentaires.
            
            **âš ï¸ Action requise:** Sans rÃ©ponse dans les 48 heures, cette issue sera automatiquement fermÃ©e pour maintenir le projet organisÃ©.
            
            ðŸ’¡ **Que faire:**
            - RÃ©pondez aux questions posÃ©es ci-dessus
            - Fournissez les logs ou informations demandÃ©s
            - Indiquez si le problÃ¨me est rÃ©solu
            
            Si l'issue est fermÃ©e automatiquement et que le problÃ¨me persiste, n'hÃ©sitez pas Ã  rouvrir ou crÃ©er une nouvelle issue avec les informations complÃ¨tes.

            ---

            ðŸ‡¬ðŸ‡§ **English:**
            This issue is marked as "awaiting response" because we need additional information.
            
            **âš ï¸ Action required:** Without a response within 48 hours, this issue will be automatically closed to keep the project organized.
            
            ðŸ’¡ **What to do:**
            - Answer the questions asked above
            - Provide the requested logs or information
            - Indicate if the problem is resolved
            
            If the issue is auto-closed and the problem persists, feel free to reopen or create a new issue with complete information.

          close-issue-message: |
            **ðŸ”’ Auto-closed / FermÃ© automatiquement**

            ðŸ‡«ðŸ‡· Cette issue a Ã©tÃ© fermÃ©e automatiquement en raison de l'absence de rÃ©ponse. Si le problÃ¨me persiste, n'hÃ©sitez pas Ã  crÃ©er une nouvelle issue avec les informations complÃ¨tes.

            ðŸ‡¬ðŸ‡§ This issue was automatically closed due to lack of response. If the problem persists, feel free to create a new issue with complete information.

          days-before-stale: 3
          days-before-close: 2
          stale-issue-label: 'awaiting-response'
          exempt-issue-labels: 'bug,enhancement,in-progress,confirmed'
          operations-per-run: 30

  label-by-keywords:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Auto-label issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            const labels = [];

            // Check for migration issues
            if (body.includes('v1.2') || body.includes('migration') || body.includes('macro_name') || body.includes('device_name')) {
              labels.push('migration');
            }

            // Check for MQTT issues
            if (body.includes('mqtt') || body.includes('broker')) {
              labels.push('mqtt');
            }

            // Check for sensor issues
            if (body.includes('sensor.') || body.includes('commands_')) {
              labels.push('sensors');
            }

            // Check for service issues
            if (body.includes('service:') || body.includes('trigger_macro') || body.includes('trigger_device_command')) {
              labels.push('services');
            }

            // Check for RS90 firmware issues
            if (body.includes('firmware') || body.includes('haptique config')) {
              labels.push('rs90-firmware');
            }

            if (labels.length > 0) {
              github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }
