name: Tests & Validation

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  validate-structure:
    name: Validate Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          test -f custom_components/haptique_rs90/__init__.py || exit 1
          test -f custom_components/haptique_rs90/manifest.json || exit 1
          test -f custom_components/haptique_rs90/coordinator.py || exit 1
          test -f custom_components/haptique_rs90/sensor.py || exit 1
          test -f custom_components/haptique_rs90/switch.py || exit 1
          test -f custom_components/haptique_rs90/config_flow.py || exit 1
          echo "✅ Structure OK"

      - name: Validate manifest.json
        run: |
          python3 -m json.tool custom_components/haptique_rs90/manifest.json
          VERSION=$(grep -o '"version": *"[^"]*"' custom_components/haptique_rs90/manifest.json | cut -d'"' -f4)
          echo "Version: $VERSION"
          echo "INTEGRATION_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Check Python syntax
        run: |
          for file in custom_components/haptique_rs90/*.py; do
            python3 -m py_compile "$file"
          done
          echo "✅ Python syntax OK"

  hassfest:
    name: Hassfest Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Hassfest
        uses: home-assistant/actions/hassfest@master

  hacs:
    name: HACS Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, hassfest, hacs]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate-structure.result }}" != "success" ]; then
            echo "❌ Structure validation failed"
            exit 1
          fi
          if [ "${{ needs.hassfest.result }}" != "success" ]; then
            echo "❌ Hassfest validation failed"
            exit 1
          fi
          if [ "${{ needs.hacs.result }}" != "success" ]; then
            echo "❌ HACS validation failed"
            exit 1
          fi
          echo "✅ All tests passed!"
